<!DOCTYPE html>
<html lang="fr">
<head>
        <meta charset="utf-8" />
        <title>Interop Ansible & Cisco NSO</title>
        <link rel="stylesheet" href="https://automaticdavid.github.io/theme/css/main.css" />
        <link href="https://automaticdavid.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="It's automatic! Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://automaticdavid.github.io/">It's automatic! </a></h1>
                <nav><ul>
                    <li class="active"><a href="https://automaticdavid.github.io/category/ansible.html">Ansible</a></li>
                    <li><a href="https://automaticdavid.github.io/category/personal.html">Personal</a></li>
                    <li><a href="https://automaticdavid.github.io/category/tower.html">Tower</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://automaticdavid.github.io/nso-06-2020-fr.html" rel="bookmark"
           title="Permalink to Interop Ansible & Cisco NSO">Interop Ansible & Cisco NSO</a></h1>
    </header>

    <div class="entry-content">
        <abbr class="published" title="2020-06-05T00:00:00+02:00">
                Published: Fri 05 June 2020
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/ansible.html">Ansible</a>.<P>
      <p>Ansible est très performant pour automatiser les equipement réseau. Mais parfois les clients ont deja une infra <a href="https://www.cisco.com/c/en/us/solutions/service-provider/solutions-cloud-providers/network-services-orchestrator-solutions.html">Cisco NSO</a> en place. Les modules Ansible pour NSO permettent d'utiliser les deux solutions en cote à cote, de passer de l'une à l'autre de façon simple et finalement de rendre NSO plus interessant.</p>
<p>Le code utilisé est à:<br>
<a href="https://github.com/automaticdavid/ansible-nso">https://github.com/automaticdavid/ansible-nso</a></p>
<p>Vous pouvez facilement tester en utilisant, comme moi, le lab NSO proposé par Cisco:
<a href="https://devnetsandbox.cisco.com/RM/Topology">https://devnetsandbox.cisco.com/RM/Topology</a></p>
<h2>1- Piloter le sync NSO</h2>
<p><img alt="NSO" src="https://automaticdavid.github.io/images/nso1.gif"></p>
<p>Dans cette première partie on commence par executer le playbook <code>check_sync.yml</code> qui permet de verifier que les switches presents dans l'infra sont synchronisés avec la base NSO. C'est un exemple d'utilisation du module ansible <code>nso_action</code> qui permet de declencher des actions NSO. On l'execute d'abord pour un switch nommé et ensuite on check le sync pour tous les equipements. </p>
<p>Ensuite j'execute le playbook <code>show_address.yml</code>: c'est un exemple d'utilisation du module <code>nso_query</code> qui permet de faire une requete XPATH contre NSO, et que j'utilise pour afficher les IP des mes equipements. Je me connecte ensuite à un switch et je modifie la configuration en direct. Executer de nouveau <code>check_sync.yml</code> montre alors que l'equipement en question est "out-of-sync". Il devient facile de gerer cette exception dans un playbook, en ouvrant un tiquet dans un ITSM par exemple ou en declenchant une action de remediation. </p>
<p>Cette action peut etre par exemple le playbook que j'execute ensute, qui effectue un sync-to NSO: il pousse la configuration NSO vers le switch. J'execute ensuite le <code>check_sync.yml</code>de nouveau pour verifier que tout est synchrone. </p>
<h2>2- Source Of Truth avec NSO</h2>
<p><img alt="NSO" src="https://automaticdavid.github.io/images/nso2.gif"></p>
<p>Dans cette deuxieme etape on commence par utiliser le module <code>nso_verify</code> pour effectuter un backup de la conf NSO. Ce qu'on obtient c'est une copie local des config des equipements, sous forme de YAML. On peut donc utiliser ces fichier comme "source de verité" de l'infrastructure, en la stockant dans git par exemple. </p>
<p>Je continue en modifiant une information de configuration pour un des equipements dans son fichier de description. J'excecute ensuite le playbook <code>apply_sot.yml</code>. La premiere tache lit les infos de la "source of truth" et les applique à la configuration NSO en utilisant le module <code>nso_config</code>. On fait ensuite un <code>nso_verify</code> qui montre qu'il y a bien une violation correspondant à la modification que nous avons effectuée, c'est à dire que l'equipement n'est pas synchro avec la config NSO:</p>
<p><img alt="NSO" src="https://automaticdavid.github.io/images/nso3.png"></p>
<p>On effectue donc un sync-to dans la tache "Apply SOT" et un dernier "Check sync" confirme que l'equipement a a été synchronisé avec la source de verité. </p>
<p>On peut aussi verifier un element de configuration particulier, c'est ce que montre le playbook <code>verify_config.yml</code>: on verifie juste un sous ensemble de la config NSO. Cela peut être interessant par exemple si on veut verifier un meme element de config mais sur un très grand nombre d'equipement. </p>
<p>Enfin j'execute le playbook <code>apply_sot.yml</code> une seconde fois: il ne se passe rien et "changed" est à 0. en effet, le playbook est indempotent est Ansible ne fait rien s'il n'y a rien a faire. Avec <code>--check-mode</code> cela permet de verifier facilement la conformité de la config NSO. </p>
<p>Pour finir je me connecte à l'equipement pour verifier que la modification faite dans la source of truth a bien été appliquée.</p>
<h2>3- Resource Modules Ansible &amp; NSO</h2>
<p><img alt="NSO" src="https://automaticdavid.github.io/images/nso4.gif"></p>
<p>Dans cette derniere partie, on utilise un des modules reseau d'Ansible pour changer la config NXOS directement sur le switch. Le module utilisé est <code>nxos_vlan</code>: </p>
<div class="highlight"><pre><span></span><span class="err">- name: Direct device change</span>
<span class="err">  nxos_vlans:</span>
<span class="err">    config:</span>
<span class="err">      - vlan_id: 501</span>
<span class="err">        name: ansible</span>
<span class="err">    state:  merged</span>
<span class="err">  register: r_vlan</span>
</pre></div>


<p>On voit que le module remonte les etats "before" et "after" pour le changement. </p>
<p>Manipuler les conf des equipements réseau avec Ansible peut être plus simple qu'avec NSO. </p>
<p>Après le changement, on effectue une verification de la synchro NSO: evidement il y a une violation. Le playbook effectue alors un sync_from pour resynchroniser NSO depuis la configuration de l'equipement. On est donc capable d'utiliser NSO depuis Ansible, mais aussi Ansible et NSO en "cote à cote".</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://automaticdavid.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/automaticdavid">@automaticdavid</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is slightly modified from <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-166865092-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>