<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>It's automatic! - @automaticdavid</title>
        <link rel="stylesheet" href="https://automaticdavid.github.io/theme/css/main.css" />
        <link href="https://automaticdavid.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="It's automatic! Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://automaticdavid.github.io/">It's automatic! </a></h1>
                <nav><ul>
                    <li><a href="https://automaticdavid.github.io/category/ansible.html">Ansible</a></li>
                    <li><a href="https://automaticdavid.github.io/category/personal.html">Personal</a></li>
                    <li><a href="https://automaticdavid.github.io/category/tower.html">Tower</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://automaticdavid.github.io/iac-vmware.html">Infra As Code with Ansible for VMware vSphere</a></h1>
        <abbr class="published" title="2020-07-14T00:00:00+02:00">
                Published: Tue 14 July 2020
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/tower.html">Tower</a>.<P>
<p>This is a short write up about a demo I did for a Red Hat France Webinar.
You can find the full replay (in french) at: <br>
<a href="https://www.redhat.com/fr/events/webinar/automate-enterprise-infrastructure">Automatiser à l’échelle de l’entreprise et gérer l'infrastructure comme du code avec Red Hat Ansible Automation Platform</a></p>
<p>The code used is at: <br>
<a href="https://github.com/automaticdavid/demo_vmware/tree/webinar_072020">github</a></p>
<p>The inventory I'm using is at:<br>
<a href="https://github.com/automaticdavid/vmware_services/tree/master/paris">github</a></p>
<h2>1 Setting up the Inventories in Tower</h2>
<p>We're using a Tower inventory with 2 sources: one is the project that points to the git inventory "vmware service definition", the other is a vCenter based dynamic inventory:</p>
<p><img alt="Inventory" src="https://automaticdavid.github.io/images/webinar2_inventory.png"></p>
<p>Tower ships with a default vCenter inventory, but for this demo I'm using the latest upstream version. To do this I copied the upstream collection into my own repo at: <a href="https://github.com/automaticdavid/vmware_inventory.git">https://github.com/automaticdavid/vmware_inventory.git</a>.<br>
Note that I respected the collection directory path: <code>collections/ansible_collections/community/vmware/</code>  </p>
<p>I also added an <code>ansible.cfg</code> file that enables the vmware community inventory plugin and a configuration file for the plugin: <code>conf.vmware.yml</code> (this file has to end in .vmware.yml). I'm using this to force the dynamic inventory to report hostnames as the name of the VM, instead of the default which is a concatenation of the VM name and the VM UUID. </p>
<p>To use vCenter tags, we need pyvmomi (obviously) and also the python VMware Automation SDK, as documented in: (https://docs.ansible.com/ansible/latest/plugins/inventory/vmware_vm_inventory.html). <br>
To run this cleanly, I created a dedicated venv as explained in: (https://docs.ansible.com/ansible-tower/latest/html/upgrade-migration-guide/virtualenv.html)</p>
<p>Inside Tower I also defined a custom credential to use with this inventory: </p>
<p><img alt="Credential" src="https://automaticdavid.github.io/images/webinar2_cred.png"></p>
<p>This provides the environment variables needed to connect to the vCenter. Depending on the version of the collection you're using, you may also use a Tower vCenter credential for this. 
The inventory source definition in Tower is a standard "sourced from a project" definition, with an added variable to enable using the custom plugin: </p>
<p><img alt="Credential" src="https://automaticdavid.github.io/images/webinar2_inventory2.png"></p>
<p>This also allows to specify that we're using our custom venv.</p>
<h2>2 Provisioning a Service</h2>
<p>We start with an empty vCenter and a service definition in git. The definition takes place in services.ini where we add the service <code>app1</code> to the inventory:</p>
<div class="highlight"><pre><span></span><span class="k">[services:children]</span>
<span class="na">app1</span>

<span class="k">[app1]</span>
<span class="na">host1</span>
</pre></div>


<p>We also create in the <code>group_vars</code> directory a file called <code>app1.yml</code> that defines the <code>app1</code> service:</p>
<div class="highlight"><pre><span></span><span class="n">service_config</span><span class="o">:</span>
  <span class="n">vm</span><span class="o">:</span> 
    <span class="n">project</span><span class="o">:</span> <span class="n">terminator</span>
    <span class="n">role</span><span class="o">:</span> <span class="n">webserver</span>
    <span class="n">service</span><span class="o">:</span> <span class="n">app1</span>
    <span class="n">count</span><span class="o">:</span> <span class="mi">1</span>
    <span class="n">size</span><span class="o">:</span> <span class="n">small</span>
  <span class="n">app</span><span class="o">:</span> 
    <span class="n">name</span><span class="o">:</span> <span class="n">terminator_v1</span>
    <span class="n">quote</span><span class="o">:</span> <span class="n">give</span> <span class="n">me</span> <span class="n">your</span> <span class="n">boots</span><span class="o">,</span> <span class="n">your</span> <span class="n">gun</span><span class="o">,</span> <span class="n">and</span> <span class="n">your</span> <span class="n">motorcycle</span>
    <span class="n">version</span><span class="o">:</span> <span class="mi">1</span> 
  <span class="n">global</span><span class="o">:</span> 
    <span class="n">context</span><span class="o">:</span> <span class="n">movie_machine</span>
</pre></div>


<p>I like how this provides a very clean and readable definition for a service. Although this is a simple example it could very well be extended to manage more complex use cases. </p>
<p>We then run a Tower Workflow that does 4 things: </p>
<ul>
<li>Refresh the project based inventory source to read the new service definitions from git</li>
<li>Provision and tag the VMs needed for the new services</li>
<li>Refresh the vCenter dynamic inventory once the VM are provisioned, getting the tags as Tower inventory groups</li>
<li>Run a playbook that install the application layer needed on each VM of the services, based on the VM's groups.</li>
</ul>
<p>Here's a video of what it looks like (better in full screen): </p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/V0hhakK6Uwc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>On my lab setup, the workflow takes less than 4mn to complete.</p>
<h2>3 Adding and Modifying a Service</h2>
<p>The playbook we call in the Job Template is indempotent: when I add a whole new service, running the same workflow just adds what's needed without doing anything to our already provisioned service. </p>
<p>In the video below, I add a new service <code>app2</code> but also modify the <code>version</code> value of the <code>app1</code> service. In the Tower log we can see that Ansible does only what's needed and leaves what is already configured untouched. </p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/XfyPkvEOqSE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>We can also use git to track changes to the services definitions: </p>
<p><img alt="Git diff" src="https://automaticdavid.github.io/images/webinar2_git.png"></p>
<h2>4 Force delete of a VM</h2>
<p>What's cool with Ansible is that the IaC behaviour is based on indempotency of playbooks and definition of state in a source of truth (the inventory in git), as opposed to other tools that need their own statefull reference. This means that I can delete a VM in vCenter and when the Job Template is executed again, it just corrects what's missing (in this lab the IP of the recreated VM changes, but in real life we'd use an IPAM). We are not locked to only one control plane.   </p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/K0xLGhgTuhA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>We can also run the Job Template in <code>check_mode</code> and do compliance checking. </p>
<h2>What's next</h2>
<p>There's a number of other things we could do from here:  </p>
<ul>
<li>Enable <a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/webhooks.html">webhooks</a></li>
<li>Enable different environements to test and promote our infrastructure and services definitions</li>
<li>Add support for changing the VM's hardware definition of a provisioned service</li>
<li>Use pull requests to manage the services definitions </li>
<li>Add other roles for services, for instance eap </li>
</ul>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="https://automaticdavid.github.io/nso-06-2020.html" rel="bookmark"
                           title="Permalink to Interop Ansible & Cisco NSO">Interop Ansible & Cisco NSO</a></h1>
                </header>

                <div class="entry-content">
        <abbr class="published" title="2020-06-05T00:00:00+02:00">
                Published: Fri 05 June 2020
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/ansible.html">Ansible</a>.<P>
Translations:
        <a href="https://automaticdavid.github.io/nso-06-2020-fr.html" hreflang="fr">fr</a>
                <p>Ansible is a powerful solution to manage network infrastructure. But sometimes there's already a <a href="https://www.cisco.com/c/en/us/solutions/service-provider/solutions-cloud-providers/network-services-orchestrator-solutions.html">Cisco NSO</a> setup. The Ansible modules for NSO allow using the two solutions side by side, automating NSO with Ansible. </p>
<p>The code is available at:<br>
<a href="https://github.com/automaticdavid/ansible-nso">https://github.com/automaticdavid/ansible-nso</a></p>
<p>This can be tested using the …</p>
                <a class="readmore" href="https://automaticdavid.github.io/nso-06-2020.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://automaticdavid.github.io/webinar-05-2020.html" rel="bookmark"
                           title="Permalink to Using Ansible to manage ios devices">Using Ansible to manage ios devices</a></h1>
                </header>

                <div class="entry-content">
        <abbr class="published" title="2020-05-15T00:00:00+02:00">
                Published: Fri 15 May 2020
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/ansible.html">Ansible</a>.<P>
Translations:
        <a href="https://automaticdavid.github.io/webinar-05-2020-fr.html" hreflang="fr">fr</a>
                <p>Here's a small write up on the demo I did for our "Beyond Linux, Automate all the things" webinar.</p>
<p>The code I used is at:<br>
<a href="https://github.com/automaticdavid/webinar_052020">https://github.com/automaticdavid/webinar_052020</a></p>
<p>The security workshop can be accessed at:<br>
<a href="https://ansible.github.io/workshops/">https://ansible.github.io/workshops/</a></p>
<p>The webinar replay (in french) is at:<br>
<a href="https://www.redhat.com/en/events/webinar/red-hat-ansible-automation-platform-cloud-reseau-iot-lautomatisation-au-dela-des-systemes-linux">L …</a></p>
                <a class="readmore" href="https://automaticdavid.github.io/webinar-05-2020.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://automaticdavid.github.io/personal-picks-for-summit-2020.html" rel="bookmark"
                           title="Permalink to Personal picks for Summit 2020">Personal picks for Summit 2020</a></h1>
                </header>

                <div class="entry-content">
        <abbr class="published" title="2020-04-20T00:00:00+02:00">
                Published: Mon 20 April 2020
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/personal.html">Personal</a>.<P>
                <p>There's a looooot of sessions at the <a href="https://www.redhat.com/en/summit">Red Hat Summit 2020</a> but on the plus side it's a free virtual experience, so register now! I picked the following Automation sessions for myself and thought I would share. All those are CEST times.<br>
You can view the full catalogue at: <a href="https://summit.redhat.com/conference/sessions">https …</a></p>
                <a class="readmore" href="https://automaticdavid.github.io/personal-picks-for-summit-2020.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://automaticdavid.github.io/using-conditional-import-of-external-vars-with-towers-smart-inventories.html" rel="bookmark"
                           title="Permalink to Using conditional import of external vars with Tower's Smart Inventories">Using conditional import of external vars with Tower's Smart Inventories</a></h1>
                </header>

                <div class="entry-content">
        <abbr class="published" title="2019-10-20T00:00:00+02:00">
                Published: Sun 20 October 2019
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/tower.html">Tower</a>.<P>
                <p>The problem we are trying to solve is that smart inventories in Tower do not include groups, and therefore we can't use group_vars defined at the inventories level. Since host_vars are imported we will use a host_var to trigger import of the wanted vars.</p>
<h2>1- VM Properties</h2>
<p>We're going to …</p>
                <a class="readmore" href="https://automaticdavid.github.io/using-conditional-import-of-external-vars-with-towers-smart-inventories.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="https://automaticdavid.github.io/configure-an-ssh-proxy-for-ansible-tower.html" rel="bookmark"
                           title="Permalink to Configure an SSH proxy for Ansible Tower">Configure an SSH proxy for Ansible Tower</a></h1>
                </header>

                <div class="entry-content">
        <abbr class="published" title="2019-04-19T00:00:00+02:00">
                Published: Fri 19 April 2019
        </abbr>

<BR>In <a href="https://automaticdavid.github.io/category/tower.html">Tower</a>.<P>
                <p>In my lab, some of the VMs I provision are only accessible through a jump host. This means Tower needs to connect to the jump host first then to the target VMs in order to run playbooks. </p>
<p>One way to enable Tower to reach isolated nodes is to use a …</p>
                <a class="readmore" href="https://automaticdavid.github.io/configure-an-ssh-proxy-for-ansible-tower.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://automaticdavid.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/automaticdavid">@automaticdavid</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is slightly modified from <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-166865092-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>